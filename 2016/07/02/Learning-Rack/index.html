<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="ruby,rack," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="说明这几天在看关于rack的知识点，边看边整理。最大的感受就是看技术书会不断地牵扯出新的知识点，不同的人会有不同的理解。 
恍然大悟，生命就该如此。
什么是Rack?我查看wiki：

Rack provides a modular and adaptable interface for developing web applications in Ruby. By wrapping HTTP r">
<meta property="og:type" content="article">
<meta property="og:title" content="Learning Rack">
<meta property="og:url" content="http://yoursite.com/2016/07/02/Learning-Rack/index.html">
<meta property="og:site_name" content="Mx-Don">
<meta property="og:description" content="说明这几天在看关于rack的知识点，边看边整理。最大的感受就是看技术书会不断地牵扯出新的知识点，不同的人会有不同的理解。 
恍然大悟，生命就该如此。
什么是Rack?我查看wiki：

Rack provides a modular and adaptable interface for developing web applications in Ruby. By wrapping HTTP r">
<meta property="og:updated_time" content="2016-07-03T12:59:34.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Learning Rack">
<meta name="twitter:description" content="说明这几天在看关于rack的知识点，边看边整理。最大的感受就是看技术书会不断地牵扯出新的知识点，不同的人会有不同的理解。 
恍然大悟，生命就该如此。
什么是Rack?我查看wiki：

Rack provides a modular and adaptable interface for developing web applications in Ruby. By wrapping HTTP r">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/07/02/Learning-Rack/"/>

  <title> Learning Rack | Mx-Don </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mx-Don</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Learning Rack
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-02T09:30:15+08:00" content="2016-07-02">
              2016-07-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>这几天在看关于rack的知识点，边看边整理。<br>最大的感受就是看技术书会不断地牵扯出新的知识点，不同的人会有不同的理解。 </p>
<p>恍然大悟，生命就该如此。</p>
<h2 id="什么是Rack"><a href="#什么是Rack" class="headerlink" title="什么是Rack?"></a>什么是Rack?</h2><p>我查看wiki：</p>
<blockquote>
<p>Rack provides a modular and adaptable interface for developing web applications in Ruby. By wrapping HTTP requests and responses it unifies the API for web servers, web frameworks, and software in between (the so-called middleware) into a single method call.</p>
</blockquote>
<p>Rack是web server interface，定义了规范。<br>Rack将HTTP requests 和 responses包装好，便于web server 跟 web application之间的调用，一个Rack application可以被任何跟Rack兼容的web server调用。</p>
<a id="more"></a>
<ul>
<li>主流的ruby server都支持Rack接口。（WEBrick, Thin, Unicorn …）</li>
<li>主流的ruby web 框架也都支持。(Rails ,Sinatra, Grape …)</li>
</ul>
<h2 id="这是Rack规范。"><a href="#这是Rack规范。" class="headerlink" title="这是Rack规范。"></a>这是Rack规范。</h2><p><a href="http://www.rubydoc.info/github/rack/rack/master/file/SPEC" target="_blank" rel="external">Rack规范书</a><br>内容不多，定义了一些标准。</p>
<h2 id="什么是Rack-Application"><a href="#什么是Rack-Application" class="headerlink" title="什么是Rack Application?"></a>什么是Rack Application?</h2><p>就是符合Rack规范的程序都是，像Rails, Sinatra这些框架写出来的程序都是啦,如果我们想要自己用ruby写一个，也完全可以。</p>
<p>这是一段有内涵的代码，在后面也会反反复复出现很多很多的次。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Myapp</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></div><div class="line">    [<span class="number">200</span>, &#123;<span class="string">"Content-Type"</span> =&gt; <span class="string">"text/html"</span>&#125;, [<span class="string">"hello world."</span>]]</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">rackapp = Myapp.new</div><div class="line">Rack::Handler::WEBrick.run rackapp, <span class="symbol">:Port</span> =&gt; <span class="number">3000</span></div></pre></td></tr></table></figure></p>
<p>ok,我们已经完成了一个Rack Application了。<br>直接在浏览器访问：<code>http://localhost:3000/</code> ==&gt; <code>&quot;hello world.&quot;</code></p>
<h3 id="如何理解这个过程？"><a href="#如何理解这个过程？" class="headerlink" title="如何理解这个过程？"></a>如何理解这个过程？</h3><p>发送了一个http请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost:3000/</div></pre></td></tr></table></figure></p>
<p>返回了这样的响应：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Length: 77</div><div class="line">Content-Type: text/html</div><div class="line">hello world.</div></pre></td></tr></table></figure></p>
<p>Now, say you’re a web server. You have this Rack app loaded in you. And some browser came to you with that request having path ‘/‘. As a server you understand this HTTP request. But you don’t know what to do with it. You have to give it to your Rack app, because it knows very well what to do with such a request.</p>
<p>There is a problem though. Your Rack app does not understand browser requests directly. You need to translate it in a way that he can make sense of it, work with it and then give you a response which you yourself can understand. But the Rack app is kind of a nut-job and doesn’t co-operate easily. So you take the app to a counsellor, to come up with a system.</p>
<p>The counsellor’s name is ‘Rack’. He says, ‘Look Rack app, the server is ready to work together. He’s going to translate the HTTP request in a format that I’ll tell him to. This format will be easy for you to understand. In return, you have to give him a response that he can easily work with. I’ll tell you how your response should look like. Okay?’</p>
<blockquote>
<p>Rack is basically a specification of these two things:</p>
<ul>
<li>what the server should send to the app </li>
<li>what the app should return to the server.</li>
</ul>
</blockquote>
<p>That’s it.</p>
<h3 id="需要符合什么标准呢？"><a href="#需要符合什么标准呢？" class="headerlink" title="需要符合什么标准呢？"></a>需要符合什么标准呢？</h3><p>在规范书里面这样写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">A Rack application is a Ruby object (not a class) that responds to call. It takes exactly one argument, the environment and returns an Array of exactly three values: The status, the headers, and the body.</div></pre></td></tr></table></figure>
<ul>
<li>是一个ruby 对象，不是一个类。</li>
<li>这个对象可以被call调用。</li>
<li>需要接受一个env参数。</li>
<li>需要返回一个数组，包含status + headers + body。</li>
</ul>
<h3 id="what-can-be-call-？"><a href="#what-can-be-call-？" class="headerlink" title="what can be call ？"></a>what can be <code>call</code> ？</h3><p>ruby中，能够响应的call的有几种。  </p>
<ul>
<li>lambda + Proc  </li>
<li>一个类定义了一个叫做call的实例方法。    </li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">lambda &#123;<span class="params">|env|</span> [<span class="number">200</span>, &#123;<span class="string">"Content-Type"</span> =&gt; <span class="string">"text/html"</span>&#125;, [<span class="string">"hello world."</span>]]&#125;</div><div class="line"></div><div class="line"><span class="comment"># or</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Myapp</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></div><div class="line">    [<span class="number">200</span>, &#123;<span class="string">"Content-Type"</span> =&gt; <span class="string">"text/html"</span>&#125;, [<span class="string">"hello world."</span>]]</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h3 id="what-is-the-env"><a href="#what-is-the-env" class="headerlink" title="what is the env ?"></a>what is the <code>env</code> ?</h3><p>如果我访问：<code>http://localhost:3000/search?key=redis</code>,得到的env会类似这样:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">GATEWAY_INTERFACE - CGI/1.1</div><div class="line">HTTP_ACCEPT - text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</div><div class="line">HTTP_ACCEPT_ENCODING - gzip, deflate, sdch</div><div class="line">HTTP_ACCEPT_LANGUAGE - zh-CN,zh;q=0.8,en;q=0.6</div><div class="line">HTTP_CONNECTION - keep-alive</div><div class="line">HTTP_HOST - localhost:3000</div><div class="line">HTTP_UPGRADE_INSECURE_REQUESTS - 1</div><div class="line">HTTP_USER_AGENT - Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36</div><div class="line">HTTP_VERSION - HTTP/1.1</div><div class="line">PATH_INFO - /search</div><div class="line">QUERY_STRING - key=redis</div><div class="line">REMOTE_ADDR - ::1</div><div class="line">REMOTE_HOST - ::1</div><div class="line">REQUEST_METHOD - GET</div><div class="line">REQUEST_PATH - /search</div><div class="line">REQUEST_URI - http://localhost:3000/search?key=redis</div><div class="line">SCRIPT_NAME -</div><div class="line">SERVER_NAME - localhost</div><div class="line">SERVER_PORT - 3000</div><div class="line">SERVER_PROTOCOL - HTTP/1.1</div><div class="line">SERVER_SOFTWARE - WEBrick/1.3.1 (Ruby/2.3.0/2015-12-25)</div><div class="line">rack.errors - #&lt;IO:0x007fb9b309eb28&gt;</div><div class="line">rack.hijack - #&lt;Proc:0x007fb9b247fae0@/Users/Don/.rvm/gems/ruby-2.3.0/gems/rack-1.6.4/lib/rack/handler/webrick.rb:76 (lambda)&gt;</div><div class="line">rack.hijack? - true</div><div class="line">rack.hijack_io -</div><div class="line">rack.input - #&lt;StringIO:0x007fb9b247fc20&gt;</div><div class="line">rack.multiprocess - false</div><div class="line">rack.multithread - true</div><div class="line">rack.run_once - false</div><div class="line">rack.url_scheme - http</div><div class="line">rack.version - [1, 3]</div></pre></td></tr></table></figure>
<p>server调用Rack将env传给了app.<br>app是根据这个env来处理用户的请求的，返回对应的响应。env的rack参数规格书里面有说明。</p>
<p>如：会根据<code>PATH_INFO</code>来map路由。</p>
<h3 id="what-is-the-status"><a href="#what-is-the-status" class="headerlink" title="what is the status ?"></a>what is the <code>status</code> ?</h3><h3 id="what-is-the-headers"><a href="#what-is-the-headers" class="headerlink" title="what is the headers ?"></a>what is the <code>headers</code> ?</h3><h3 id="what-is-the-body"><a href="#what-is-the-body" class="headerlink" title="what is the body ?"></a>what is the <code>body</code> ?</h3><p>body是返回的显示结果。配合headers可以被浏览器渲染成不同的东西。<br>body必须可以被each,一般使用字符串的数组。</p>
<h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h2><p>Rack提供的处理浏览器发来的请求的接口。可以将格式化所传的env.<br>request = Rack::Request.new(env)</p>
<p>获取URL的查询参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">request.params[:search_key]</div></pre></td></tr></table></figure></p>
<p>获取path:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">request.path_info</div></pre></td></tr></table></figure></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">rack_app = lambda &#123;<span class="params">|env|</span></div><div class="line">  <span class="comment"># 使用Rack的类来进行初始化参数。</span></div><div class="line">  request = Rack::Request.new(env) </div><div class="line">  <span class="keyword">if</span> request.path_info == <span class="string">'/guess'</span></div><div class="line">    <span class="comment"># url?client=xxx</span></div><div class="line">    client = request[<span class="string">"client"</span>]</div><div class="line">    <span class="keyword">if</span> client &amp;&amp; client.downcase == <span class="string">'safari'</span></div><div class="line">      [<span class="number">200</span>, &#123;&#125;, [<span class="string">"yeah, sweet heart!!"</span>]]</div><div class="line">    <span class="keyword">else</span></div><div class="line">      [<span class="number">200</span>, &#123;&#125;, [<span class="string">"please choose another one!!"</span>]]</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">else</span></div><div class="line">    [<span class="number">200</span>, &#123;&#125;, [<span class="string">"you should choose /guess path!!"</span>]]</div><div class="line">  <span class="keyword">end</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h2><p>处理返回的结果：</p>
<ul>
<li>直接设置返回结果 response.body, 此时必须自己设置Content-Length的长度。</li>
<li>直接使用response.write, 会自动计算Content-Length的长度。<br>不管用那种方法，最后都调用Response.finish来结束。</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">'rack'</span></div><div class="line"></div><div class="line">rack_app = lambda &#123; <span class="params">|env|</span></div><div class="line"></div><div class="line">  request = Rack::Request.new(env)</div><div class="line">  response = Rack::Response.new</div><div class="line"></div><div class="line">  body = <span class="string">"---------header----------&lt;br&gt;"</span></div><div class="line">  <span class="keyword">if</span> request.path_info == <span class="string">"/hello"</span> <span class="comment"># 路由</span></div><div class="line"></div><div class="line">    body &lt;&lt; <span class="string">" you say hello &lt;br&gt;"</span></div><div class="line">    body &lt;&lt; <span class="string">"from <span class="subst">#&#123;client&#125;</span> &lt;br&gt;"</span> <span class="keyword">if</span> client = request[<span class="string">'client'</span>]</div><div class="line"></div><div class="line">  <span class="keyword">else</span></div><div class="line">    body &lt;&lt; <span class="string">"you need enter something.&lt;br&gt;"</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  body &lt;&lt; <span class="string">"---------footer----------&lt;br&gt;"</span></div><div class="line">  body &lt;&lt; <span class="string">"&lt;b&gt;here is bye bye ... &lt;/b&gt;"</span></div><div class="line"></div><div class="line">  response.body = [body]</div><div class="line">  response.header[<span class="string">'Content-Length'</span>] = body.bytesize.to_s</div><div class="line">  response.header[<span class="string">'Content-Type'</span>] = <span class="string">'text/plain'</span></div><div class="line">  response.finish</div><div class="line"></div><div class="line">  <span class="comment"># or</span></div><div class="line">  response.write body</div><div class="line">  response.header[<span class="string">'Content-Type'</span>] = <span class="string">'text/html'</span></div><div class="line"></div><div class="line">  response.finish</div><div class="line">&#125;</div><div class="line"></div><div class="line">Rack::Handler::WEBrick.run rack_app, <span class="symbol">:Port</span> =&gt; <span class="number">3000</span></div></pre></td></tr></table></figure>
<h2 id="中间件-–-middleware"><a href="#中间件-–-middleware" class="headerlink" title="中间件 – middleware"></a>中间件 – middleware</h2><p>中间件可以实现业务逻辑与通用逻辑的分离。而这些通用逻辑可以被不同的业务逻辑使用。</p>
<ul>
<li>中间件而已独立发展。</li>
<li>各种中间件可以根据框架需要自由组合。</li>
</ul>
<h3 id="have-a-look"><a href="#have-a-look" class="headerlink" title="have a look"></a>have a look</h3><p>一个简单的Rack程序，比如上面那个，使用两个中间件middleware1 and middleware2。</p>
<p>可以这样写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Rack::Handler::WEBrick.run Middleware1.new(Middleware2.new(rackapp)), :Port =&gt; 3000</div></pre></td></tr></table></figure>
<p>如果使用很多中间件，那这样会变得很难看。顺序也不容易调整。</p>
<p>我们希望可以看到类似下面的结构：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Builder.new <span class="keyword">do</span> </div><div class="line">    use Middleware1</div><div class="line">    use Middleware2</div><div class="line">    run Rack_App</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>这边文章就不单独写代码实现了。在另外一篇文章仔细地写一下如何写出DSL。</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ruby/" rel="tag">#ruby</a>
          
            <a href="/tags/rack/" rel="tag">#rack</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/01/守夜人/" rel="next" title="守夜人">
                <i class="fa fa-chevron-left"></i> 守夜人
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/03/Observer-Pattern/" rel="prev" title="Observer Pattern">
                Observer Pattern <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/hexo_avatar.png"
               alt="chenxiaodong" />
          <p class="site-author-name" itemprop="name">chenxiaodong</p>
          <p class="site-description motion-element" itemprop="description">人生如逆旅，我亦是行人。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">13</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#说明"><span class="nav-number">1.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是Rack"><span class="nav-number">2.</span> <span class="nav-text">什么是Rack?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#这是Rack规范。"><span class="nav-number">3.</span> <span class="nav-text">这是Rack规范。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是Rack-Application"><span class="nav-number">4.</span> <span class="nav-text">什么是Rack Application?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#如何理解这个过程？"><span class="nav-number">4.1.</span> <span class="nav-text">如何理解这个过程？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#需要符合什么标准呢？"><span class="nav-number">4.2.</span> <span class="nav-text">需要符合什么标准呢？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-can-be-call-？"><span class="nav-number">4.3.</span> <span class="nav-text">what can be call ？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-the-env"><span class="nav-number">4.4.</span> <span class="nav-text">what is the env ?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-the-status"><span class="nav-number">4.5.</span> <span class="nav-text">what is the status ?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-the-headers"><span class="nav-number">4.6.</span> <span class="nav-text">what is the headers ?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-the-body"><span class="nav-number">4.7.</span> <span class="nav-text">what is the body ?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Request"><span class="nav-number">5.</span> <span class="nav-text">Request</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Response"><span class="nav-number">6.</span> <span class="nav-text">Response</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#中间件-–-middleware"><span class="nav-number">7.</span> <span class="nav-text">中间件 – middleware</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#have-a-look"><span class="nav-number">7.1.</span> <span class="nav-text">have a look</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chenxiaodong</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  

  

  

</body>
</html>
