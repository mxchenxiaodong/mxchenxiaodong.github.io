<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Rails,concern," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="Append_feaures
When this module is included in another, ruby calls append_features in this module, passing it the receiving module in mod.Ruby’s default implementation to add the constants, methods, a">
<meta property="og:type" content="article">
<meta property="og:title" content="Learning Concern">
<meta property="og:url" content="http://yoursite.com/2016/07/03/Learning-Concern/index.html">
<meta property="og:site_name" content="Mx-Don">
<meta property="og:description" content="Append_feaures
When this module is included in another, ruby calls append_features in this module, passing it the receiving module in mod.Ruby’s default implementation to add the constants, methods, a">
<meta property="og:updated_time" content="2016-07-03T13:04:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Learning Concern">
<meta name="twitter:description" content="Append_feaures
When this module is included in another, ruby calls append_features in this module, passing it the receiving module in mod.Ruby’s default implementation to add the constants, methods, a">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/07/03/Learning-Concern/"/>

  <title> Learning Concern | Mx-Don </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mx-Don</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Learning Concern
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-03T19:38:12+08:00" content="2016-07-03">
              2016-07-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Append-feaures"><a href="#Append-feaures" class="headerlink" title="Append_feaures"></a>Append_feaures</h2><blockquote>
<p>When this module is included in another, ruby calls append_features in this module, passing it the receiving module in mod.<br>Ruby’s default implementation to add the constants, methods, and module variables of this module to mod if this module has not  already been added to mod or one of is its ancestors.</p>
</blockquote>
<h2 id="Include-and-Extend"><a href="#Include-and-Extend" class="headerlink" title="Include and Extend"></a>Include and Extend</h2><blockquote>
<p>Module defines the callback “included” and “extended” which are called when a module  is include or extend into another class or module .</p>
</blockquote>
<a id="more"></a>
<ul>
<li>include : Adds to class the instance methods from each module, as instance methods.<ul>
<li>module的类方法不会被引入。</li>
</ul>
</li>
<li>extend : Adds to object the instance methods from each module, as singleton methods.<ul>
<li>class User is a object. =&gt; User.extend(:Auth) =&gt; 属于这User类的单例方法，也可以称作类方法。</li>
<li>user = User.new, user is also is a object. =&gt; user.extend(:Auth) =&gt; 属于这个用户的单例方法。</li>
</ul>
</li>
</ul>
<h2 id="Metaprogramming-with-some-useful-methods"><a href="#Metaprogramming-with-some-useful-methods" class="headerlink" title="Metaprogramming with some useful methods"></a>Metaprogramming with some useful methods</h2><ul>
<li>instance_variables: 可以得到所有实例变量。(@instance*)</li>
<li>instance_variable_defined?: 是否定义了该实例变量。</li>
<li>instance_variable_get: 获取某个实例变量的值。(base.instance_variable_get(:@instance_one))</li>
<li>instance_variable_set: 设置某个实例变量的值。(base.instance_variable_set(:@instance_one, true))</li>
<li>const_defined?: 是否定义该常量，大写开头即是常量。(所以类也是常量，类是可以修改的，所以常量也是可以改变的。)</li>
<li>const_get: 调用某个常量。可以是模块。</li>
</ul>
<h2 id="Concern-is-coming"><a href="#Concern-is-coming" class="headerlink" title="Concern is coming"></a>Concern is coming</h2><p>concern主要能够解决的问题：it gracefully handles module dependencies —— handle the <code>base</code> question.</p>
<p>the example is come from rails code.</p>
<p>如果我们引入一个模块：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#模块一</span></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Foo</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></div><div class="line">    base.class_eval <span class="keyword">do</span>  <span class="comment">#打开base类</span></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">method_injected_by_foo</span> <span class="comment">#定义一个类方法，当然，这里可以写其他在单独类文件里可以写的任何东西。</span></span></div><div class="line">        ...</div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment">#模块二</span></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Bar</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></div><div class="line">    base.method_injected_by_foo</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment">#在一个类中包含模块(第一版)</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Host</span></span></div><div class="line">  <span class="keyword">include</span> Foo</div><div class="line">  <span class="keyword">include</span> Bar  <span class="comment">#这里就存在一个问题，其实，对于调用者来说，是不需要手动调用Foo模块，它完全可以直接包含在Bar模块里面。</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment">#改成这样子</span></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Bar</span></span></div><div class="line">  <span class="keyword">include</span> Foo <span class="comment">#在这里包含进来</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></div><div class="line">    base.method_injected_by_foo <span class="comment">#调用上面Foo定义的方法。</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment">#在一个类中包含模块(第二版)</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Host</span></span></div><div class="line">  <span class="keyword">include</span> Bar</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment">#可是可惜了，这个暂时不能工作。可以细细分析一下。</span></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Bar</span></span></div><div class="line">  <span class="keyword">include</span> Foo <span class="comment">#问题1在这里, 此时为Foo定义了’method_injected_by_foo’ —- base是’Foo’。</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span>  <span class="comment">#问题2在这里，此时调用Host的’method_injected_by_foo’ — base是’Host’,之前并没有定义。</span></div><div class="line">    base.method_injected_by_foo <span class="comment">#调用上面Foo定义的方法。</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>需要解决的问题主要问题：</p>
<ul>
<li>能不能知道直到最后才确定<code>base</code>,而不是一旦include就马上加载。</li>
<li>由于module的 included 跟 extended的特定模式，所以只能重写喽。</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Concern</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">extended</span><span class="params">(base)</span></span></div><div class="line">    base.instance_variable_set(“@_dependencies”, [])</div><div class="line">    <span class="comment">#当extend该模块时，会动态创建一个实例变量。</span></div><div class="line">    <span class="comment">#要注意这里为嘛要建立一个这样实例变量？！！！ — —实例变量就是用来存东西。</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Bar</span></span></div><div class="line">  extend Concern</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">Bar.instance_variables =&gt; [<span class="symbol">:</span>@_dependencies]</div><div class="line">Bar.instance_variable_get(<span class="symbol">:</span>@_dependencies) =&gt; []</div></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Concern</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">included</span><span class="params">(base = <span class="literal">nil</span>, &amp;block)</span></span>  <span class="comment"># 当被extend， 这个方法会变成一个类方法。</span></div><div class="line">    <span class="keyword">if</span> base.<span class="literal">nil</span>?</div><div class="line">      @_included_block = block <span class="comment"># so make sure included is only one.. this is important.</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">      <span class="keyword">super</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="comment">#override included method, make it can store the block in a instance variable..</span></div><div class="line"><span class="comment">#when base is not passed , the block is stored in @_included_block for later.</span></div><div class="line"><span class="comment">#when base is passed,  delegates to the default implementation.</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Host</span></span></div><div class="line">  <span class="comment"># as a module , it has itself included and extended.</span></div><div class="line">  <span class="comment"># like Host.included and Host.extended.</span></div><div class="line">  <span class="comment"># they will be callback when is include or extend.</span></div><div class="line"></div><div class="line">  extend ActiveSupport::Concern</div><div class="line">  <span class="comment">#执行上述代码之后，即会把 Concern 里面的included变成类方法加进来， 即变成Host.included.</span></div><div class="line">  <span class="comment">#由于ruby是从头执行的，所以后定义的将会覆盖前面的，即override了默认的方法。</span></div><div class="line"></div><div class="line">  included <span class="keyword">do</span> <span class="comment">#相当于self.included</span></div><div class="line">    ...</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">concern</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">append_features</span><span class="params">(base)</span></span></div><div class="line">    <span class="keyword">if</span> base.instance_variable_defined?(<span class="symbol">:</span>@_dependencies) <span class="comment">#如果包含此变量，则说明需要延迟调用。</span></div><div class="line">      base.instance_variable_get(<span class="symbol">:</span>@_dependencies) &lt;&lt; <span class="keyword">self</span></div><div class="line">      <span class="comment">#注意此时的self，并不是base. 所以很多情况，要十分明确，当前的self究竟是谁。</span></div><div class="line">      <span class="comment">#到这里可以知道，@_dependencies这个实例变量是用来动态存放所要include的module。</span></div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">    <span class="keyword">else</span> <span class="comment">#如果不包含此变量，则说明是没有 "extend ActiveSupport::Concern”, 表明是到了最终的base,也就是最后include的地方。</span></div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> base &lt; <span class="keyword">self</span> <span class="comment">#这个地方有点不懂，防止循环依赖么？</span></div><div class="line"></div><div class="line">      @_dependencies.each &#123;<span class="params">|dep|</span> base.send(<span class="symbol">:include</span>, dep)&#125;  <span class="comment">#动态include各个模块。 此处该好好体验ruby中的send.</span></div><div class="line">      <span class="keyword">super</span> <span class="comment">#原本该处理的。 上面跟下面都只是辅助而已.</span></div><div class="line"></div><div class="line">      base.extend const_get(<span class="string">"ClassMethod"</span>) <span class="keyword">if</span> const_defined?(“ClassMethod”) <span class="comment">#动态添加类方法.</span></div><div class="line">      base.class_eval(&amp;@_included_block) <span class="keyword">if</span> instance_variable_get(<span class="symbol">:</span>@_included_block) <span class="comment">#这个即原来self.included里的东西.</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h2 id="Important"><a href="#Important" class="headerlink" title="Important"></a>Important</h2><ul>
<li>先把要执行的code变成一个块存起来。 —— 改写included</li>
<li>有个标记判断是不是最后的base，把之前存起来的代码块一股脑执行。</li>
</ul>
<h2 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h2><ul>
<li><a href="https://ruby-china.org/topics/19812" target="_blank" rel="external">ActiveSupport::Concern 小结</a></li>
<li><a href="http://www.monkeyandcrow.com/blog/reading_rails_concern/" target="_blank" rel="external">Reading Rails - Concern</a></li>
<li><a href="http://www.zhubert.com/blog/2013/06/13/activesupport-concern-digression/" target="_blank" rel="external">ActiveSupport::Concern Digression</a></li>
</ul>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Rails/" rel="tag">#Rails</a>
          
            <a href="/tags/concern/" rel="tag">#concern</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/03/Observer-Pattern/" rel="next" title="Observer Pattern">
                <i class="fa fa-chevron-left"></i> Observer Pattern
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/03/荒谬的宇宙/" rel="prev" title="荒谬的宇宙">
                荒谬的宇宙 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/hexo_avatar.png"
               alt="chenxiaodong" />
          <p class="site-author-name" itemprop="name">chenxiaodong</p>
          <p class="site-description motion-element" itemprop="description">人生如逆旅，我亦是行人。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">24</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Append-feaures"><span class="nav-number">1.</span> <span class="nav-text">Append_feaures</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Include-and-Extend"><span class="nav-number">2.</span> <span class="nav-text">Include and Extend</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Metaprogramming-with-some-useful-methods"><span class="nav-number">3.</span> <span class="nav-text">Metaprogramming with some useful methods</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Concern-is-coming"><span class="nav-number">4.</span> <span class="nav-text">Concern is coming</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Important"><span class="nav-number">5.</span> <span class="nav-text">Important</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关文章"><span class="nav-number">6.</span> <span class="nav-text">相关文章</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chenxiaodong</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  

  

  

</body>
</html>
